@model AvanzadaWeb.ViewModels.ScheduleAppointmentViewModel

@{
    ViewData["Title"] = "Agendar Turno";
    Layout = "_UserLayout";
}

<div class="row">
    <div class="col-lg-8">
        <h2 class="mb-4">Agendar Turno</h2>

        @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
        {
            <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
        }
        else
        {
            <form asp-action="ScheduleAppointment" method="post" id="ScheduleAppointmentForm">

                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">1. Seleccione Fecha y Hora</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="day-selector" class="form-label">Día:</label>
                            <select id="day-selector" name="FechaSeleccionada" class="form-select" required>
                                <option value="" selected disabled>Cargando días disponibles...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Horario disponible:</label>
                            <div id="time-slots-container" class="d-flex flex-wrap gap-2">
                                <p id="time-slots-placeholder" class="text-muted">Seleccione un día para ver los horarios.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">2. Seleccione su Vehículo</h5>
                    </div>
                    <div class="card-body">
                        <label for="vehiculo" class="form-label">Mi Vehículo:</label>
                        <select id="vehiculo" name="IdVehiculo" class="form-select" required>
                            <option value="" selected disabled>Seleccione un vehículo...</option>
                            @if (Model.VehiculosUsuario != null)
                            {
                                @foreach (var v in Model.VehiculosUsuario)
                                {
                                    <option value="@v.IDVehiculo">@v.Marca @v.Modelo (@v.Patente)</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                <input type="hidden" id="SelectedFechaHora" name="SelectedFechaHora" />

                @if (Model.ServiciosSeleccionados != null)
                {
                    @for (int i = 0; i < Model.ServiciosSeleccionados.Count; i++)
                    {
                        <input type="hidden" asp-for="@Model.ServiciosSeleccionados[i].IdTipoServicio" />
                        <input type="hidden" asp-for="@Model.ServiciosSeleccionados[i].Nombre" />
                        <input type="hidden" asp-for="@Model.ServiciosSeleccionados[i].Precio" />
                        <input type="hidden" asp-for="@Model.ServiciosSeleccionados[i].TiempoEstimado" />
                    }
                }
            </form>
        }
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm" style="position: sticky; top: 20px;">
            <div class="card-header">
                <h5 class="mb-0">Resumen del Turno</h5>
            </div>
            <div class="card-body">
                @if (Model.ServiciosSeleccionados != null && Model.ServiciosSeleccionados.Any())
                {
                    <ul class="list-group list-group-flush mb-3">
                        @foreach (var item in Model.ServiciosSeleccionados)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                <span>@item.Nombre</span>
                                <span class="text-muted">$@item.Precio.ToString("N2")</span>
                            </li>
                        }
                    </ul>

                    <h5 class="d-flex justify-content-between mb-3">
                        <span>Total:</span>
                        <strong>$@Model.TotalAPagar.ToString("N2")</strong>
                    </h5>

                    <p class="text-muted">
                        <i class="bi bi-clock"></i>
                        Duración total estimada: <strong>@Model.DuracionNuevoTurnoMinutos minutos</strong>
                    </p>
                }
                else
                {
                    <p>No hay servicios seleccionados.</p>
                }

                <div class="d-grid">
                    <button type="submit" form="ScheduleAppointmentForm" id="btnConfirmarTurno" class="btn btn-primary btn-lg" disabled>
                        Confirmar Turno
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const diasDisponibles = JSON.parse('@Html.Raw(Model.DiasDisponiblesJson)');
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- 1. Elementos del DOM ---
            const daySelector = document.getElementById("day-selector");
            const slotsContainer = document.getElementById("time-slots-container");
            const slotsPlaceholder = document.getElementById("time-slots-placeholder");
            const btnConfirmar = document.getElementById("btnConfirmarTurno");
            const hiddenFechaHoraInput = document.getElementById("SelectedFechaHora");
            const vehiculoSelect = document.getElementById("vehiculo");

            let selectedSlotButton = null;

            // --- 2. Lógica de UI (Poblar <select> y botones) ---

            function poblarSelectDias() {
                // No limpiar. Solo cambiar el texto del primer <option>
                const firstOption = daySelector.querySelector("option[disabled]");

                if (!diasDisponibles || diasDisponibles.length === 0) {
                     if(firstOption) firstOption.textContent = "No hay días disponibles";
                     daySelector.disabled = true;
                     return;
                }

                diasDisponibles.forEach((dia, index) => {
                    const option = document.createElement("option");
                    option.value = index; // Usar el índice del array
                    option.textContent = dia.texto.charAt(0).toUpperCase() + dia.texto.slice(1);
                    daySelector.appendChild(option);
                });

                if(firstOption) firstOption.textContent = "Seleccione un día...";
            }

            function poblarSlots(slots) {
                limpiarSlots();
                slotsContainer.innerHTML = ""; // Limpiar placeholder

                if (!slots || slots.length === 0) {
                    slotsContainer.innerHTML = `<p class="text-muted">No quedan slots para este día.</p>`;
                    return;
                }

                slots.forEach(slot => {
                    const slotButton = document.createElement("button");
                    slotButton.type = "button";
                    slotButton.className = "btn btn-outline-primary time-slot";
                    slotButton.dataset.time = slot.hora;
                    slotButton.dataset.datetime = slot.fechaHoraISO; // ISO String
                    slotButton.textContent = slot.hora;
                    slotButton.addEventListener("click", () => seleccionarSlot(slotButton));
                    slotsContainer.appendChild(slotButton);
                });
            }

            function limpiarSlots() {
                slotsContainer.innerHTML = "";
                slotsContainer.appendChild(slotsPlaceholder);
                slotsPlaceholder.textContent = "Seleccione un día para ver los horarios.";
                selectedSlotButton = null;
                hiddenFechaHoraInput.value = "";
                checkConfirmButtonState();
            }

            function seleccionarSlot(slotButton) {
                if (selectedSlotButton) {
                    selectedSlotButton.classList.remove("btn-primary");
                    selectedSlotButton.classList.add("btn-outline-primary");
                }

                slotButton.classList.remove("btn-outline-primary");
                slotButton.classList.add("btn-primary");
                selectedSlotButton = slotButton;

                hiddenFechaHoraInput.value = slotButton.dataset.datetime;
                checkConfirmButtonState();
            }

            function checkConfirmButtonState() {
                const slotSeleccionado = selectedSlotButton != null;
                const vehiculoSeleccionado = vehiculoSelect.value !== "";
                btnConfirmar.disabled = !(slotSeleccionado && vehiculoSeleccionado);
            }

            // --- 3. Event Listeners ---
            daySelector.addEventListener("change", function () {
                const selectedIndex = this.value;
                if (selectedIndex === "") {
                    limpiarSlots();
                    return;
                }
                const selectedDay = diasDisponibles[selectedIndex];
                poblarSlots(selectedDay.slots);
            });

            vehiculoSelect.addEventListener("change", checkConfirmButtonState);

            // --- 4. Iniciar ejecución ---
            if (diasDisponibles) {
                poblarSelectDias();
            } else {
                 const firstOption = daySelector.querySelector("option[disabled]");
                 if(firstOption) firstOption.textContent = "Error al cargar días";
                 daySelector.disabled = true;
            }
        });
    </script>
}