@model AvanzadaWeb.ViewModels.VehiculoViewModel
@{
    ViewData["Title"] = "Editar Vehículo";
    Layout = "_UserLayout";
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-pencil-fill"></i> @ViewData["Title"]</h5>
            </div>
            <div class="card-body">
                <form asp-action="Edit" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <input type="hidden" asp-for="IDVehiculo" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="IDMarca" class="form-label">Marca *</label>
                                <select asp-for="IDMarca" class="form-select" id="marcaSelect"
                                        asp-items="@Model.MarcasList">
                                    <option value="">Seleccionar marca...</option>
                                </select>
                                <span asp-validation-for="IDMarca" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="IDModelo" class="form-label">Modelo *</label>
                                <select asp-for="IDModelo" class="form-select" id="modeloSelect"
                                        asp-items="@Model.ModelosList">
                                </select>
                                <span asp-validation-for="IDModelo" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Year" class="form-label">Año *</label>
                                <input asp-for="Year" class="form-control" type="number" min="1990" max="@(DateTime.Now.Year + 1)" required>
                                <span asp-validation-for="Year" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Patente" class="form-label">Patente *</label>
                                <input asp-for="Patente" class="form-control" placeholder="ABC123 o AB123CD" maxlength="7" required style="text-transform: uppercase;">
                                <span asp-validation-for="Patente" class="text-danger"></span>
                                <small class="form-text text-muted">Formato: ABC123 o AB123CD</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="IDCombustible" class="form-label">Tipo de Combustible *</label>
                        <select asp-for="IDCombustible" class="form-select" asp-items="@Model.CombustiblesList" required>
                            <option value="">Seleccionar tipo de combustible...</option>
                        </select>
                        <span asp-validation-for="IDCombustible" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Observaciones" class="form-label">Observaciones</label>
                        <textarea asp-for="Observaciones" class="form-control" rows="3"
                                  placeholder="Información adicional sobre el vehículo" required="false"></textarea>
                        <span asp-validation-for="Observaciones" class="text-danger"></span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a asp-controller="Usuarios" asp-action="Dashboard" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const marcaSelect = document.getElementById('marcaSelect');
            const modeloSelect = document.getElementById('modeloSelect');

            // Función para habilitar/deshabilitar el select de modelos
            function toggleModeloSelect() {
                const marcaId = parseInt(marcaSelect.value, 10);
                if (isNaN(marcaId) || marcaId === 0) {
                    modeloSelect.disabled = true;
                    modeloSelect.innerHTML = '<option value="">Primero seleccione una marca...</option>';
                } else {
                    modeloSelect.disabled = false;
                    // No limpiamos las opciones aquí porque el controller ya las cargó
                }
            }

            // Cargar modelos cuando *cambia* la marca
            marcaSelect.addEventListener('change', async function() {
                const marcaId = this.value;
                modeloSelect.innerHTML = '<option value="">Cargando...</option>'; // Feedback
                toggleModeloSelect();

                if (!marcaId) return;

                try {
                    // Llamamos a la acción del VehiculosController (Web)
                    const response = await fetch(`/Vehiculos/GetModelosPorMarca?idMarca=${marcaId}`);
                    if (!response.ok) {
                        throw new Error('Error al cargar los modelos.');
                    }

                    const modelos = await response.json();

                    // Limpiar opciones
                    modeloSelect.innerHTML = '<option value="">Seleccionar modelo...</option>';

                    // Agregar los modelos correspondientes
                    modelos.forEach(modelo => {
                        const option = document.createElement('option');
                        option.value = modelo.idModelo; // API devuelve camelCase
                        option.textContent = modelo.nombre; // API devuelve camelCase
                        modeloSelect.appendChild(option);
                    });

                } catch (error) {
                    console.error('Error en fetch de modelos:', error);
                    modeloSelect.innerHTML = '<option value="">Error al cargar</option>';
                }
            });

            // --- OTROS SCRIPTS (Patente, Año) ---

            const patenteInput = document.querySelector('input[name="Patente"]');
            patenteInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            // Validación de Patente al submit
            document.querySelector('form').addEventListener('submit', function(e) {
                const patente = patenteInput.value.trim();
                const formatoViejo = /^[A-Z]{3}\d{3}$/;
                const formatoNuevo = /^[A-Z]{2}\d{3}[A-Z]{2}$/;

                if (patente && !formatoViejo.test(patente) && !formatoNuevo.test(patente)) {
                    e.preventDefault();
                    alert('Por favor, ingrese una patente válida:\n- ABC123 (formato viejo)\n- AB123CD (formato nuevo)');
                    patenteInput.focus();
                }
            });

            // Ejecutar al cargar la página
            toggleModeloSelect();
        });
    </script>
}

<style>
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .card-header {
        border-bottom: none;
    }

    .form-select:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
</style>